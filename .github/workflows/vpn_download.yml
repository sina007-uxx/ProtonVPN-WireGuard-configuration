name: ğŸŒ ProtonVPN Config Downloader & Telegram Uploader (Chrome)

on:
  workflow_dispatch:

jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    
    env:
      VPN_USERNAME: ${{ secrets.VPN_USERNAME }}
      VPN_PASSWORD: ${{ secrets.VPN_PASSWORD }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # âš™ï¸ Setup Python and Install Selenium
      - name: âš™ï¸ Setup Python and Install Selenium
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3 python3-pip zip 
          pip3 install selenium

      # ğŸŒ Install Chrome/Chromium and ChromeDriver
      - name: ğŸŒ Install Google Chrome and ChromeDriver
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: 'stable' 
      
      # ğŸš€ Execute the Python script.
      - name: ğŸƒ Execute ProtonVPN Downloader
        run: python3 proton_downloader_chrome.py

      # --- Steps for Telegram Upload ---
      
      - name: ğŸ—œï¸ Compress Downloaded Files
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ZIP_FILENAME="configs_${TIMESTAMP}.zip"
          
          if [ -d "downloaded_configs" ] && [ "$(ls -A downloaded_configs)" ]; then
            zip -r "$ZIP_FILENAME" downloaded_configs/
            echo "ZIP_FILE=$ZIP_FILENAME" >> $GITHUB_ENV
          else
            echo "::warning::Download directory is empty or not found. Skipping Telegram upload."
            echo "ZIP_FILE=NOT_FOUND" >> $GITHUB_ENV
          fi

      - name: ğŸ“¬ Send Configs to Telegram Channel
        if: env.ZIP_FILE != 'NOT_FOUND'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ env.TELEGRAM_CHAT_ID }}
          token: ${{ env.TELEGRAM_BOT_TOKEN }}
          document: ${{ env.ZIP_FILE }}
          # *** ØªØºÛŒÛŒØ± Ú©Ù„ÛŒØ¯ÛŒ: 'caption' Ø¨Ù‡ 'message' ØªØºÛŒÛŒØ± ÛŒØ§ÙØª ***
          message: |
            âœ… ProtonVPN Configs Downloaded Successfully!
            Generated by GitHub Action
            Actor: ${{ github.actor }}
          
      - name: âœ… Clean up
        if: always()
        run: rm -rf downloaded_configs *.zip
